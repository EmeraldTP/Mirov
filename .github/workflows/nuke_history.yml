name: ‚ò¢Ô∏è NUKE Repository & Deployments

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: '–ù–∞–ø–∏—à–∏—Ç–µ "DELETE" —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –¥–µ–ø–ª–æ–µ–≤.'
        required: true
        default: ''

jobs:
  nuke-everything:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # –î–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –≤–µ—Ç–æ–∫
      deployments: write   # –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ–µ–≤ (GitHub Pages –∏ –¥—Ä.)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Safety Check
        if: ${{ inputs.confirmation != 'DELETE' }}
        run: |
          echo "‚ùå –û–®–ò–ë–ö–ê: –í—ã –Ω–µ –≤–≤–µ–ª–∏ —Å–ª–æ–≤–æ DELETE. –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
          exit 1

      - name: üî• Nuke Deployments History
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç –ò—â—É –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ—à–ª—ã–µ –¥–µ–ø–ª–æ–∏..."
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö ID –¥–µ–ø–ª–æ–µ–≤ —á–µ—Ä–µ–∑ API
          DEPLOYMENTS=$(gh api "repos/${{ github.repository }}/deployments" --paginate --jq '.[].id')
          
          if [ -z "$DEPLOYMENTS" ]; then
            echo "‚úÖ –ò—Å—Ç–æ—Ä–∏—è –¥–µ–ø–ª–æ–µ–≤ —É–∂–µ –ø—É—Å—Ç–∞."
          else
            for id in $DEPLOYMENTS; do
              echo "üóëÔ∏è –£–¥–∞–ª—è—é –¥–µ–ø–ª–æ–π ID: $id"
              # –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ API (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω)
              gh api "repos/${{ github.repository }}/deployments/$id" -X DELETE || true
            done
            echo "‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ –æ –¥–µ–ø–ª–æ—è—Ö —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã."
          fi

      - name: üî• Rewrite Git History
        run: |
          git config --global user.name "Cleaner Bot"
          git config --global user.email "actions@github.com"
          
          echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: ${{ github.ref_name }}"

          # 1. –°–æ–∑–¥–∞–µ–º —Å–∏—Ä–æ—Ç—Å–∫—É—é –≤–µ—Ç–∫—É (–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª–µ–π)
          git checkout --orphan temp_nuke_branch
          
          # 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã
          git add -A
          
          # 3. –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç
          git commit -m "Initial commit (Global Reset)"
          
          # 4. –ñ–µ—Å—Ç–∫–æ –ø—É—à–∏–º
          git push origin temp_nuke_branch:${{ github.ref_name }} --force

          echo "‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞."
